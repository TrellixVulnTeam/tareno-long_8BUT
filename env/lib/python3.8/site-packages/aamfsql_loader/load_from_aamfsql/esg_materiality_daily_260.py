import logging

import pandas as pd

from aamfsql_loader.load_from_aamfsql.util import query_to_interface
from sray_db.apps import apps

log = logging.getLogger(__name__)


def upload(start_date, end_date):
    app = apps['ESGMaterialityDaily'][(2, 6, 0, 0)]

    q = f"""
SELECT f.date,
	a.assetid,
	a.be_cor AS be,
	a.cap_str,
	a.cg_boa,
	a.cg_tra,
	a.e_air,
	a.e_man,
	a.e_oth,
	a.es_bio,
	a.for_acc,
	a.hc_com,
	a.hc_div,
	a.hc_emp,
	a.hc_hri,
	a.hc_lri,
	a.hc_ohs,
	a.hc_trd,
	a.pl_qas,
	a.ru_ene,
	a.ru_wat,
	a.s_ene,
	a.sr_com,
	a.sr_pra
FROM(
	SELECT w.date,
	p.primary_equity_assetid AS assetid,
	w.be_cor,
	w.cap_str,
	w.cg_boa,
	w.cg_tra,
	w.e_air,
	w.e_man,
	w.e_oth,
	w.es_bio,
	w.for_acc,
	w.hc_com,
	w.hc_div,
	w.hc_emp,
	w.hc_hri,
	w.hc_lri,
	w.hc_ohs,
	w.hc_trd,
	w.pl_qas,
	w.ru_ene,
	w.ru_wat,
	w.s_ene,
	w.sr_com,
	w.sr_pra, COALESCE(LEAD(date) OVER (PARTITION BY p.primary_equity_assetid ORDER BY date ASC), GETUTCDATE()) AS next_date
	FROM ResDaBa.[dbo].[f_esg_weights] w
	LEFT MERGE JOIN AraBaDa.dbo.view_asset_primary_equity_assetid p ON p.assetid = w.assetid
	WHERE job_id = 77991
) a
LEFT MERGE JOIN (
	SELECT a.date,
		b.primary_equity_assetid AS assetid,  
		a.be_cor,
		a.cap_str,
		a.cg_boa,
		a.cg_tra,
		a.e_air,
		a.e_man,
		a.e_oth,
		a.es_bio,
		a.for_acc,
		a.hc_com,
		a.hc_div,
		a.hc_emp,
		a.hc_hri,
		a.hc_lri,
		a.hc_ohs,
		a.hc_trd,
		a.pl_qas,
		a.ru_ene,
		a.ru_wat,
		a.s_ene,
		a.sr_com,
		a.sr_pra
	FROM ResDaBa.dbo.f_sray_features a
	LEFT MERGE JOIN AraBaDa.dbo.view_asset_primary_equity_assetid b ON a.assetid = b.assetid
	WHERE job_id = 77991
) f ON a.assetid = f.assetid
	AND f.date >= a.date AND f.date < a.next_date
WHERE f.date BETWEEN '{start_date}' AND '{end_date}'"""

    log.info(f'{pd.Timestamp.now()}: Starting upload for {app.name} from {start_date} to {end_date}')
    query_to_interface(q, app)
