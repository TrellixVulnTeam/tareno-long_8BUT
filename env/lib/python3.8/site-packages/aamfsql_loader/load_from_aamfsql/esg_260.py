from sray_db.apps import apps
from aamfsql_loader.load_from_aamfsql.util import query_to_interface

import pandas as pd

def upload(start_date, end_date):

    app = apps['ESG'][(2, 6, 0, 0)]

    q = f"""
    SELECT assetid,
        date,
        CAST(ROUND(esg, 2) AS NUMERIC(10,2)) AS esg, 
        CAST(ROUND(esg_e, 2) AS NUMERIC(10,2)) AS esg_e, 
        CAST(ROUND(esg_s, 2) AS NUMERIC(10,2)) AS esg_s, 
        CAST(ROUND(esg_g, 2) AS NUMERIC(10,2)) AS esg_g, 
        CAST(ROUND(esg_e_weight, 4) AS NUMERIC(10,4)) AS esg_e_weight, 
        CAST(ROUND(esg_s_weight, 4) AS NUMERIC(10,4)) AS esg_s_weight, 
        CAST(ROUND(esg_g_weight, 4) AS NUMERIC(10,4)) AS esg_g_weight, 
        CAST(ROUND(e_air_weight, 4) AS NUMERIC(10,4)) AS e_air_weight, 
        CAST(ROUND(e_man_weight, 4) AS NUMERIC(10,4)) AS e_man_weight, 
        CAST(ROUND(e_oth_weight, 4) AS NUMERIC(10,4)) AS e_oth_weight, 
        CAST(ROUND(es_bio_weight, 4) AS NUMERIC(10,4)) AS es_bio_weight, 
        CAST(ROUND(ru_ene_weight, 4) AS NUMERIC(10,4)) AS ru_ene_weight, 
        CAST(ROUND(ru_wat_weight, 4) AS NUMERIC(10,4)) AS ru_wat_weight, 
        CAST(ROUND(s_ene_weight, 4) AS NUMERIC(10,4)) AS s_ene_weight, 
        CAST(ROUND(be_weight, 4) AS NUMERIC(10,4)) AS be_weight, 
        CAST(ROUND(cap_str_weight, 4) AS NUMERIC(10,4)) AS cap_str_weight, 
        CAST(ROUND(cg_tra_weight, 4) AS NUMERIC(10,4)) AS cg_tra_weight, 
        CAST(ROUND(cg_boa_weight, 4) AS NUMERIC(10,4)) AS cg_boa_weight, 
        CAST(ROUND(for_acc_weight, 4) AS NUMERIC(10,4)) AS for_acc_weight, 
        CAST(ROUND(hc_com_weight, 4) AS NUMERIC(10,4)) AS hc_com_weight, 
        CAST(ROUND(hc_div_weight, 4) AS NUMERIC(10,4)) AS hc_div_weight, 
        CAST(ROUND(hc_emp_weight, 4) AS NUMERIC(10,4)) AS hc_emp_weight, 
        CAST(ROUND(hc_hri_weight, 4) AS NUMERIC(10,4)) AS hc_hri_weight, 
        CAST(ROUND(hc_lri_weight, 4) AS NUMERIC(10,4)) AS hc_lri_weight, 
        CAST(ROUND(hc_ohs_weight, 4) AS NUMERIC(10,4)) AS hc_ohs_weight, 
        CAST(ROUND(hc_trd_weight, 4) AS NUMERIC(10,4)) AS hc_trd_weight, 
        CAST(ROUND(pl_qas_weight, 4) AS NUMERIC(10,4)) AS pl_qas_weight, 
        CAST(ROUND(sr_com_weight, 4) AS NUMERIC(10,4)) AS sr_com_weight, 
        CAST(ROUND(sr_pra_weight, 4) AS NUMERIC(10,4)) AS sr_pra_weight
    FROM(
        SELECT a.assetid, 
            a.date,
            a.value AS esg, 
            b.value AS esg_e, 
            c.value AS esg_s, 
            d.value AS esg_g,
            COALESCE(e_air, 0) + COALESCE(e_man, 0) + COALESCE(e_oth, 0) + COALESCE(es_bio, 0) + COALESCE(ru_ene, 0) + COALESCE(ru_wat, 0) + COALESCE(s_ene, 0) AS esg_e_weight,
            COALESCE(hc_com, 0) + COALESCE(hc_div, 0) + COALESCE(hc_emp, 0) + COALESCE(hc_hri, 0) + COALESCE(hc_lri, 0) + COALESCE(hc_ohs, 0) + COALESCE(hc_trd, 0) + COALESCE(pl_qas, 0) + COALESCE(sr_com, 0) + COALESCE(sr_pra, 0) AS esg_s_weight,
            COALESCE(be_cor, 0) + COALESCE(cap_str, 0) + COALESCE(cg_tra, 0) + COALESCE(cg_boa, 0) + COALESCE(for_acc, 0) AS esg_g_weight,
            e.e_air AS e_air_weight, 
            e.e_man AS e_man_weight, 
            e.e_oth AS e_oth_weight, 
            e.es_bio AS es_bio_weight, 
            e.ru_ene AS ru_ene_weight, 
            e.ru_wat AS ru_wat_weight, 
            e.s_ene AS s_ene_weight, 
            e.be_cor AS be_weight, 
            e.cap_str AS cap_str_weight, 
            e.cg_tra AS cg_tra_weight, 
            e.cg_boa AS cg_boa_weight, 
            e.for_acc AS for_acc_weight, 
            e.hc_com AS hc_com_weight, 
            e.hc_div AS hc_div_weight, 
            e.hc_emp AS hc_emp_weight, 
            e.hc_hri AS hc_hri_weight, 
            e.hc_lri AS hc_lri_weight, 
            e.hc_ohs AS hc_ohs_weight, 
            e.hc_trd AS hc_trd_weight, 
            e.pl_qas AS pl_qas_weight, 
            e.sr_com AS sr_com_weight, 
            e.sr_pra AS sr_pra_weight
        FROM ResDaBa.dbo.f_esg a
        LEFT MERGE JOIN ResDaBa.dbo.f_esg_e b ON a.assetid = b.assetid AND a.date = b.date AND a.job_id = b.job_id
        LEFT MERGE JOIN ResDaBa.dbo.f_esg_s c ON a.assetid = c.assetid AND a.date = c.date AND a.job_id = c.job_id
        LEFT MERGE JOIN ResDaBa.dbo.f_esg_g d ON a.assetid = d.assetid AND a.date = d.date AND a.job_id = d.job_id
        LEFT MERGE JOIN ValDaBa.dbo.view_sray_esg_weights_filtered_primary_260 e ON a.assetid = e.assetid AND a.date = e.date
        WHERE a.job_id = 77991
            AND a.date BETWEEN '{start_date}' AND '{end_date}'
    ) a
    """

    query_to_interface(q, app)
