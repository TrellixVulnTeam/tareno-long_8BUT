import time

from flask import Response, g, request

from arabesque_py.api.flask.middleware.middleware import Middleware
from arabesque_py.prometheus.middleware import PrometheusMiddleware


class PrometheusFlaskMiddleware(PrometheusMiddleware, Middleware):
    def before_request(self):
        """
        Updates the flask request with a start time
        """
        g.start_time = time.time()

    def after_request(self, response: Response) -> Response:
        """
            Updates the requests metric count and updates the histogram for request/response time
        Args:
            response: For getting the status code
        """

        self.finish_request(
            g.start_time, request.path, response.status_code, request.method
        )

        return response
