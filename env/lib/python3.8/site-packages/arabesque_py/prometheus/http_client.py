from flask_restful import Resource
from prometheus_client import CollectorRegistry, generate_latest, multiprocess

DEFAULT_PATH = "/_internal/metrics"
RESPONSE_CONTENT_TYPE = "text/plain; version=0.0.4; charset=utf-8"


class PrometheusHTTPClient(Resource):
    registry: CollectorRegistry
    path: str
    threaded: bool
    mutliproc_dir: str

    def get_data(self) -> str:
        """
        Gets the latest prometheus data to respond with

        Returns:
            str: The prometheus data
        """
        registry = CollectorRegistry(auto_describe=True)
        if self.threaded:
            multiprocess.MultiProcessCollector(registry, self.multiproc_dir)
        data = generate_latest(registry)
        return str(data.decode("utf-8"))
