import time

from falcon import Request, Response

from arabesque_py.prometheus.middleware import PrometheusMiddleware


class PrometheusFalconMiddleware(PrometheusMiddleware):
    def process_request(self, req: Request, resp: Response):
        """
            This is a stub for the falcon middleware - updates the request with
            a start time
        Args:
            req: unused
            resp: unused
        """
        req.start_time = time.time()

    def process_response(
        self, request: Request, response: Response, resource, req_succeeded: bool
    ):
        """
            This is a stub for the falcon middleware - updates the requests
            metric count and updates the histogram for request/response time
        Args:
            request: The request for getting the start time, path and method
            response: The response for getting the status
            resource: unused
            req_succeeded: unused
        """
        self.finish_request(
            request.start_time, request.path, int(response.status[:3]), request.method
        )
