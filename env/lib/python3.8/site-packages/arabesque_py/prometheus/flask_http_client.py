from flask import Response
from flask_restful import Api, Resource

from arabesque_py.prometheus import http_client
from arabesque_py.prometheus.http_client import PrometheusHTTPClient


class PrometheusFlaskHTTPClient(PrometheusHTTPClient, Resource):
    def __init__(self, **kwargs):
        """
        A HTTP client - for returning the metrics for the give endpoint

        Args:
            registry: This is the prometheus registry
            path: The metrics path
        """
        self.registry = kwargs["registry"]
        self.path = kwargs["path"]
        self.threaded = kwargs["threaded"] if kwargs["threaded"] is not None else True
        self.multiproc_dir = kwargs["multiproc_dir"]

    def get(self):
        """
        Generates the prometheus metric path output for flask
        """
        return Response(self.get_data(), mimetype=http_client.RESPONSE_CONTENT_TYPE)

    def attach(self, app: Api):
        """
        Args:
            app: The falcon app you want to attach to
        """
        app.add_resource(self, self.path)
