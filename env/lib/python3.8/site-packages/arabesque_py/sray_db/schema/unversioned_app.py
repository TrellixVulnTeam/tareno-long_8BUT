import typing

import marshmallow as ma

from arabesque_py.sray_db import IS_SRAY_DB_INSTALLED


class UnversionedAppSchema(ma.Schema):
    """
    References an existing UnversionedApp instance that is declared in the AppRegistry

    Example:
        from arabesque_py.sray_db import UnversionedAppSchema
        unv_app = UnversionedAppSchema().load({'name': 'ESG'})
        print(unv_app)  # Output: UnversionedApp(name=ESG, versions=5)
        print(UnversionedAppSchema().dump(unv_app))  # Output: {'name': 'ESG'}
    ```
    """

    name = ma.fields.String(required=True)

    @ma.post_load
    def make_unversioned_app(
        self, data: typing.Dict, **kwargs
    ) -> "sray_db.apps.unversioned_app.UnversionedApp":
        """Return an sray_db UnversionedApp instance if sray_db is installed, else just pass on the data"""
        if not IS_SRAY_DB_INSTALLED:
            return data

        from sray_db.apps import apps

        app_name = data["name"]
        unversioned_app = apps[app_name]

        return unversioned_app
