"""
This file contains helpers for converting timestamps and datetimes into
protobuf2 timestamps.

TODO:
    (@miles-arabesque): Add tests.
"""

import time
from datetime import datetime

from google.protobuf import timestamp_pb2


def get_protobuf_timestamp(add_seconds=0) -> timestamp_pb2.Timestamp:
    """
    Gets the protobuf timestamp for now.

    Args:
        add_seconds: How many seconds you want to add to the timestamp

    Returns:
        timestamp_pb2.Timestamp: The protobuf timestamp
    """
    assert add_seconds >= 0, "add_seconds must be 0 or greater"
    now = time.time() + add_seconds
    seconds = int(now)
    nanos = int((now - seconds) * 10 ** 9)

    return timestamp_pb2.Timestamp(seconds=seconds, nanos=nanos)


def get_protobuf_timestamp_from_dt(dt: datetime) -> timestamp_pb2.Timestamp:
    """
    Converts datetime into a protobuf

    Args:
        dt: The datetime you want to convert

    Returns:
        timestamp_pb2.Timestamp: The protobuf timestamp
    """
    seconds = int(dt.timestamp())

    return timestamp_pb2.Timestamp(seconds=seconds)


def get_protobuf_timestamp_from_date(date: datetime.date) -> timestamp_pb2.Timestamp:
    """
    Converts date into a protobuf

    Args:
        date: The date you want to convert

    Returns:
        timestamp_pb2.Timestamp: The protobuf timestamp
    """
    dt = datetime.combine(date, datetime.min.time())

    return get_protobuf_timestamp_from_dt(dt)


def proto_timestamp_to_dt(timestamp: timestamp_pb2.Timestamp) -> datetime:
    """
    Converts protobuf timestamp to python datetime

    Args:
        timestamp (timestamp_pb2.Timestamp): The protobuf timestamp to convert
            to datetime
    Returns:
        datetime: The converted datetime from timestamp
    """
    return timestamp.ToDatetime()
